import torch
import torch.nn as nn
import torch.nn.functional as F

def conv1x1(in_channels, out_channels, stride=1):
    return nn.Conv2d(in_channels, out_channels, kernel_size=1,
                     stride=stride, padding=0, bias=True)


def conv3x3(in_channels, out_channels, stride=1):
    return nn.Conv2d(in_channels, out_channels, kernel_size=3, 
                     stride=stride, padding=1, bias=True)


class ResBlock(nn.Module):
    def __init__(self, in_channels, out_channels, stride = 1, downsample = None, res_scale = 1):
        super(ResBlock, self).__init__()
        self.res_scale = res_scale
        self.conv1     = conv3x3(in_channels, out_channels, stride)
        self.relu      = nn.ReLU(inplace = True)
        self.conv2     = conv3x3(out_channels, out_channels)
        
    def forward(self, x):
        x1  = x
        out = self.conv1(x)
        out = self.relu(out)
        out = self.conv2(out)
        out = out * self.res_scale + x1
        return out
    

class SFE(nn.Module):
    def __init__(self, num_res_blocks, n_feats, res_scale):
        super(SFE, self).__init__()
        self.num_res_blocks = num_res_blocks
        self.conv_head      = conv3x3(3, n_feats)
        self.downsample1      = conv1x1(n_feats, n_feats, 2)
        self.downsample2      = conv1x1(n_feats, n_feats, 2)

        self.RBs            = nn.ModuleList()
        for i in range(self.num_res_blocks):
            self.RBs.append(ResBlock(in_channels = n_feats, out_channels = n_feats, 
                res_scale = res_scale))
            
        self.conv_tail = conv3x3(n_feats, n_feats)
        
    def forward(self, x):
        x  = F.relu(self.conv_head(x))
        x = F.relu(self.downsample1(x))
        x = F.relu(self.downsample2(x))
        
        x1 = x
        for i in range(self.num_res_blocks):
            x = self.RBs[i](x)
        x = self.conv_tail(x)
        x = x + x1
        return x
    
class MergeTail(nn.Module):
    def __init__(self, n_feats):
        super(MergeTail, self).__init__()
        self.conv13     = conv1x1(n_feats, n_feats)
        self.conv23     = conv1x1(n_feats, n_feats)
        self.conv_merge = conv3x3(n_feats*3, n_feats)
        
    def forward(self, x1, x2, x3):
        x13 = F.interpolate(x1, scale_factor=4, mode='bicubic')
        x13 = F.relu(self.conv13(x13))
        x23 = F.interpolate(x2, scale_factor=2, mode='bicubic')
        x23 = F.relu(self.conv23(x23))

        x = F.relu(self.conv_merge( torch.cat((x3, x13, x23), dim=1) ))
        
        return x

